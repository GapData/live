---
title: "Case study: wine quality"
author: "Mateusz Staniak"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r libs, echo = FALSE, warnin = FALSE, message = FALSE}
library(mlr)
library(live)
library(tidyverse)
library(bigstep)
```

### About the data 

Wine quality is a well-known dataset which was an object of study in . <!-- dodaÄ‡ cytowanie -->
According to the results from the original article, Support Vector Machine model is better than other models, including linear regression, for prediction purposes.
In this section we will show how `live` package can be used to fit linear regression model locally and generate a visual explanation for the black box model.

### Performance comparison

First, we can perform a quick bechmark experiment to see that SVM performs better than linear regression and, say, neural network.

| Learner | Mean MSE |
| ------- | -------- | 
| SVM | 0.39 |
| Linear regression | 0.43 | 
| Neural network | 0.55 | 

### Explaining single prediction

Suppose we want to understand prediction generated by SVM for the fifth observation in the dataset.
To do this, we need to generate observations for local exploration.

##### Simulating a dataset

We use `simulateSimilar` function from `live` package.
`standardise` is set to `TRUE`, so all variables will be normalized.
```{r similar, message = F, warning = F}
similar <- simulateSimilar(data = winequality_red,
                           newData = winequality_red[5, ], 
                           blackBox = "regr.svm", 
                           explainedVar = "quality", 
                           size = 50,
                           standardise = TRUE)
```

#### Training white box model

Then we fit linear regression model to predictions generated by SVM for this simulated dataset using \texttt{trainWhiteBox} function.
```{r training, warning = FALSE, message = FALSE, results='hide'}
trained <- trainWhiteBox(liveObject = similar, 
                         whiteBox = "regr.lm", 
                         selection = TRUE)
```

This function returns a native \texttt{mlr} object.
Model object (for example lm object) can be extracted using \texttt{getLearnerModel} function.
By setting \texttt{selection = TRUE} we choose to perform variable selection using AIC as implemented in \texttt{bigstep} package which is available on CRAN.

#### Model visualization

Now we can visualize fitted model by calling \texttt{plotWhiteBox} function.
```{r plot, message = F, warning = F}
plotWhiteBox(whiteBox = trained,
             observation = winequality_red[5, ])
```

Only variables chosen in the selection step are displayed.
They are sorted according to the absolute value of t-test statistic.
In the `Observed` column predictor values for case given in observation} argument are displayed.
`Estimate` column gives fitted parameter values, while `Lower` and `Upper` give lower and upper bounds of 95\% confidence interval, respectively.
The plot show `Estimate` value on x axis.
From the signs of the parameters and their magnitude wee can see how variables influence predictions.

